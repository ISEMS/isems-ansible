---
- name: Manage ISEMS-PI
  hosts: isems-raspi
  remote_user: pi
  become_method: sudo

  vars:
    sentry_dsn: !vault |
          $ANSIBLE_VAULT;1.1;AES256
          30353031313164636137666436343236353063356234656361653662333739383736303362633061
          6364653039333166333639616631336364333438373265310a363963323339346663623337393763
          30666266326463323261636466396666623231636130626639646137366662366430346634633766
          3839356461633833350a643063336463353737323361666237396332353166306537353831646666
          65383762656232336639363930316430633164393330356666653537626366326165386638303562
          36333836303738356564366463666438383932616131616335643338346334356432643939333836
          34333031363638343766376637656337303331343065396231393735353137353032616632313231
          37663831333363633439353936633762646266316662353265373135663935323936613562383863
          3535

  roles:
    - role: jdauphant.nginx
      become: true
      nginx_configs:
        gzip:
          - gzip on
        upstream:
          - upstream isems-data-collector { server unix:///tmp/uwsgi-isems-data-collector.sock; }
      nginx_http_params:
        - sendfile "on"
        - access_log "/var/log/nginx/access.log"
      nginx_sites:
        isems:
          - listen 80
          - location /api/ {
              rewrite /api/(.*) /$1 break;
              uwsgi_pass   isems-data-collector;
              include      /etc/nginx/uwsgi_params;
              add_header Access-Control-Allow-Origin *;
            }
          - location / {
              root /home/{{ansible_ssh_user}}/isems-app/build;
              index index.html;
              try_files $uri /index.html =404;
            }
    - role: geerlingguy.git
      become: true
    - role: geerlingguy.nodejs
      become: true
    - role: ocha.yarn
      become: true
    - frontend
    - flask
    - sync
