---
- name: Manage Public API
  hosts: isems-public
  remote_user: root
  become_method: sudo

  vars:
    certbot_auto_renew_user: "{{ ansible_user }}"
    certbot_auto_renew_hour: 2
    certbot_auto_renew_minute: 10
    certbot_certs:
      - domains:
        - api.isems.de

    certbot_admin_email: certbot-isems@k-nut.eu

    certbot_create_if_missing: true
    certbot_create_method: standalone
    certbot_create_standalone_stop_services: []

    sentry_dsn: !vault |
          $ANSIBLE_VAULT;1.1;AES256
          30353031313164636137666436343236353063356234656361653662333739383736303362633061
          6364653039333166333639616631336364333438373265310a363963323339346663623337393763
          30666266326463323261636466396666623231636130626639646137366662366430346634633766
          3839356461633833350a643063336463353737323361666237396332353166306537353831646666
          65383762656232336639363930316430633164393330356666653537626366326165386638303562
          36333836303738356564366463666438383932616131616335643338346334356432643939333836
          34333031363638343766376637656337303331343065396231393735353137353032616632313231
          37663831333363633439353936633762646266316662353265373135663935323936613562383863
          3535

  roles:
    - role: geerlingguy.git
      remote_user: pi
      become: true
    - role: geerlingguy.certbot
      remote_user: pi
      become: true
    - role: jdauphant.nginx
      remote_user: pi
      become: true
      nginx_configs:
        gzip:
          - gzip on
        upstream:
          - upstream isems-data-collector { server unix:///tmp/uwsgi-isems-data-collector.sock; }
      nginx_http_params:
        - sendfile "on"
        - access_log "/var/log/nginx/access.log"
      nginx_sites:
        isems:
          - listen 80
          - server_name api.isems.de
          - location / {
              uwsgi_pass   isems-data-collector;
              include      /etc/nginx/uwsgi_params;
              add_header Access-Control-Allow-Origin *;
            }
          - listen 443 ssl
          - ssl_certificate /etc/letsencrypt/live/api.isems.de/fullchain.pem
          - ssl_certificate_key /etc/letsencrypt/live/api.isems.de/privkey.pem
    - role: flask
      remote_user: pi
